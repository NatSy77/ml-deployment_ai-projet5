name: CI & Deploy to Hugging Face Space

on:
  push:
    branches:
      - main
      - "feature/*"
  pull_request:
    branches:
      - main

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install git-lfs and pull LFS objects
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install
          git lfs pull

      - name: Debug - check model file is not an LFS pointer
        run: |
          echo "=== Repo root ==="
          ls -lah
          echo "=== model dir ==="
          ls -lah model || true
          echo "=== LFS tracked files ==="
          git lfs ls-files || true
          echo "=== Head of model file (should NOT show LFS pointer) ==="
          head -n 5 model/* || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        env:
          CI: "true"
        run: |
          python -m pytest --maxfail=1 --disable-warnings -q --cov=app --cov-report=term-missing --cov-report=xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
  
  deploy_to_hf:
    name: Deploy to Hugging Face Space (prod)
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code (full history + LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Install git-lfs
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install
          git lfs pull

      - name: Push to Hugging Face Space via git
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          git remote remove space || true
          git remote add space https://NatSy94:${HF_TOKEN}@huggingface.co/spaces/NatSy94/ml-deployment-ai-projet5

          git push space HEAD:main --force
